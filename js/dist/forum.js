(()=>{var t={n:r=>{var e=r&&r.__esModule?()=>r.default:()=>r;return t.d(e,{a:e}),e},d:(r,e)=>{for(var n in e)t.o(e,n)&&!t.o(r,n)&&Object.defineProperty(r,n,{enumerable:!0,get:e[n]})},o:(t,r)=>Object.prototype.hasOwnProperty.call(t,r),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},r={};(()=>{"use strict";t.r(r);const e=flarum.core.compat["common/extend"],n=flarum.core.compat["forum/app"];var o=t.n(n);const a=flarum.core.compat["forum/states/DiscussionListState"];var s=t.n(a);const u=flarum.core.compat["common/models/Discussion"];var i=t.n(u);const c=flarum.core.compat["common/components/Badge"];var l=t.n(c);const d=flarum.core.compat["common/Model"];var f=t.n(d);function p(t,r){return p=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,r){return t.__proto__=r,t},p(t,r)}function h(t,r){t.prototype=Object.create(r.prototype),t.prototype.constructor=t,p(t,r)}var w=function(t){function r(){for(var r,e=arguments.length,n=new Array(e),o=0;o<e;o++)n[o]=arguments[o];return(r=t.call.apply(t,[this].concat(n))||this).last_read_at=f().attribute("last_read_at"),r.last_read_post_number=f().attribute("last_read_post_number"),r.subscription=f().attribute("subscription"),r.unread=f().attribute("unread"),r.user=f().hasOne("user"),r}return h(r,t),r}(f());const b=flarum.core.compat["common/components/Button"];var v=t.n(b);const k=flarum.core.compat["forum/components/DiscussionHero"];var _=t.n(k);const y=flarum.core.compat["common/components/Tooltip"];var g=t.n(y);const R=flarum.core.compat["common/helpers/avatar"];var W=t.n(R);const x=flarum.core.compat["common/helpers/listItems"];var P=t.n(x);const O=flarum.core.compat["common/utils/extractText"];var N=t.n(O);const B=flarum.core.compat["common/utils/humanTime"];var I=t.n(B);const D=flarum.core.compat["common/utils/ItemList"];var M=t.n(D),A="clarkwinkelmann-who-read.forum.badges.";function S(t,r){if(flarum.extensions["flarum-subscriptions"])switch(r.subscription()){case"follow":t.add("subscriptions-follow",l().component({label:o().translator.trans(A+"following"),icon:"fas fa-star",type:"following"}));break;case"ignore":t.add("subscriptions-ignoring",l().component({label:o().translator.trans(A+"ignoring"),icon:"far fa-eye-slash",type:"ignoring"}))}r.unread()&&t.add("who-read-unread",l().component({type:"who-read-unread",icon:o().forum.attribute("who-read.unreadIcon"),label:o().translator.trans(A+"unread")}))}function U(t){return t||0}var j=function(){function t(){this.showAll=!1}return t.prototype.view=function(t){var r=this,e=o().forum.attribute("who-read.maxVisible"),n=t.attrs,a=n.readers,s=n.extendable,u=n.discussion;return m("ul.WhoRead-list.WhoRead-summary",a.map((function(t,n){if(!r.showAll){if(n===e){var i=a.length-e;return m("span.Avatar.WhoRead-more",{title:N()(o().translator.trans("clarkwinkelmann-who-read.forum.more."+(s?"show":"info"),{count:i})),onclick:function(t){s&&(t.stopPropagation(),r.showAll=!0)}},"+"+i)}if(n>=e)return null}var c=t.user();if(!c)return null;var l=new(M());S(l,t);var d=t.unread()||u&&U(t.last_read_post_number())<U(u.lastPostNumber()),f="last-read-at";return u&&(f=d?"last-read-at-behind":"last-read-at-up-to-date"),m("li.WhoRead-item",m(g(),{text:N()(o().translator.trans("clarkwinkelmann-who-read.forum.tooltip."+f,{user:c,ago:I()(t.last_read_at())}))},m(".WhoRead-avatar",{className:d?"WhoRead-avatar--outdated":""},[W()(c),m("ul.badges",P()(l.toArray()))])))})))},t}();const L=flarum.core.compat["common/components/Modal"];var C=t.n(L);const T=flarum.core.compat["common/components/Link"];var E=t.n(T);const H=flarum.core.compat["common/helpers/username"];var q=t.n(H);const F=flarum.core.compat["common/helpers/userOnline"];var z=t.n(F),J=function(){function t(){}return t.prototype.view=function(t){return m("ul.WhoRead-list.WhoRead-details",t.attrs.readers.map((function(t){var r=t.user();if(!r)return null;var e=r.badges();return S(e,t),m("li.WhoRead-item",m(g(),{text:N()(o().translator.trans("clarkwinkelmann-who-read.forum.tooltip.last-read-at",{user:r,ago:I()(t.last_read_at())}))},m(E(),{href:o().route.user(r),"data-container":"body"},[m(".WhoRead-avatar",[W()(r),m("ul.badges",P()(e.toArray()))]),m(".WhoRead-user",[z()(r),q()(r)])])))})))},t}(),V="clarkwinkelmann-who-read.forum.modal.",G=function(t){function r(){return t.apply(this,arguments)||this}h(r,t);var e=r.prototype;return e.className=function(){return"ReadersModal"},e.title=function(){return o().translator.trans(V+"title")},e.content=function(){return m(".Modal-body",[this.section("readersUntilHereOnly","up-to-this-post"),this.section("readersFurther","past-this-post"),this.section("readersEnd","to-the-end"),this.section("readersBehind","behind")])},e.section=function(t,r){return this.attrs[t]&&this.attrs[t].length?[m("h3",o().translator.trans(V+r)),m(J,{readers:this.attrs[t]})]:null},r}(C());function K(t,r){return t.filter((function(t){if(null===t.last_read_post_number())return!1;var e=o().forum.attribute("who-read.hideWhenBehind");return!e||U(t.last_read_post_number())>U(r.lastPostNumber())-e}))}function Q(t){return!1===t?[]:t.filter((function(t){return void 0!==t}))}const X=flarum.core.compat["forum/components/DiscussionList"];var Y=t.n(X);const Z=flarum.core.compat["forum/components/DiscussionListItem"];var $=t.n(Z);const tt=flarum.core.compat["forum/components/CommentPost"];var rt=t.n(tt);const et=flarum.core.compat["forum/components/Post"];var nt=t.n(et);const ot=flarum.core.compat["common/helpers/icon"];var at=t.n(ot),st=function(){function t(){}return t.prototype.view=function(t){var r=t.attrs,e=r.discussion,n=r.className,a=!!e.attribute("whoReadUnread");return v().component({className:n,icon:o().forum.attribute("who-read.unreadIcon"),onclick:function(){e.save({whoReadUnread:!a}).then((function(){m.redraw()}))}},o().translator.trans("clarkwinkelmann-who-read.forum.controls."+(a?"remove":"set")+"-unread"))},t}(),ut="clarkwinkelmann-who-read.forum.footer.";const it=flarum.core.compat["forum/utils/DiscussionControls"];var ct=t.n(it);o().initializers.add("clarkwinkelmann-who-read",(function(){o().store.models["clarkwinkelmann-who-readers"]=w,i().prototype.clarkwinkelmannWhoReaders=i().hasMany("clarkwinkelmannWhoReaders"),(0,e.extend)(i().prototype,"badges",(function(t){this.attribute("whoReadUnread")&&t.add("who-read-unread",l().component({type:"who-read-unread",icon:o().forum.attribute("who-read.unreadIcon"),label:o().translator.trans("clarkwinkelmann-who-read.forum.badges.unread")}))})),(0,e.extend)(f().prototype,"save",(function(t,r){r.lastReadPostNumber&&t.then((function(){m.redraw()}))})),(0,e.extend)(s().prototype,"requestParams",(function(t){o().forum.attribute("who-read.canSee")&&Array.isArray(t.include)&&t.include.push("clarkwinkelmannWhoReaders.user.groups")})),(0,e.extend)(_().prototype,"items",(function(t){if(o().forum.attribute("who-read.showInHero")){var r=this.attrs.discussion,e=K(Q(r.clarkwinkelmannWhoReaders()),r);0!==e.length&&t.add("who-read",v().component({className:"Button Button--link",onclick:function(t){t.preventDefault(),o().modal.show(G,{readersEnd:e.filter((function(t){return U(t.last_read_post_number())>=U(r.lastPostNumber())})),readersBehind:e.filter((function(t){return U(t.last_read_post_number())<U(r.lastPostNumber())}))})}},m(j,{readers:e,discussion:r,extendable:!0})))}})),(0,e.extend)(Y().prototype,"requestParams",(function(t){o().forum.attribute("who-read.showInDiscussionList")&&t.include.push("clarkwinkelmannWhoReaders.user.groups")})),(0,e.extend)($().prototype,"infoItems",(function(t){if(o().forum.attribute("who-read.showInDiscussionList")){var r=this.attrs.discussion,e=r.clarkwinkelmannWhoReaders();e&&(e=K(e,r)).length&&t.add("who-read",m(j,{readers:e,discussion:r}),-120)}})),(0,e.extend)(nt().prototype,"oninit",(function(){var t=this;o().forum.attribute("who-read.showBetweenPosts")&&this.subtree.check((function(){return t.attrs.post.discussion().attribute("whoReadUnread")}),(function(){return t.attrs.post.discussion().lastReadPostNumber()}),(function(){return JSON.stringify(Q(t.attrs.post.discussion().clarkwinkelmannWhoReaders()).map((function(t){return[t.id(),t.unread(),t.last_read_post_number()]})))}))})),[nt(),rt()].forEach((function(t){(0,e.extend)(t.prototype,"footerItems",(function(t){if(o().forum.attribute("who-read.showBetweenPosts")){var r=this.attrs.post,e=r.discussion();if(e.data.relationships&&e.data.relationships.posts){var n=e.postIds(),a=n.indexOf(r.id());if(-1!==a&&a+1<n.length){var s=n[a+1],u=o().store.getById("posts",s);if(u){var i=Q(e.clarkwinkelmannWhoReaders()).filter((function(t){return U(t.last_read_post_number())>=r.number()&&U(t.last_read_post_number())<u.number()})),c=Q(e.clarkwinkelmannWhoReaders()).filter((function(t){return U(t.last_read_post_number())>=u.number()})),l=i.length+c.length,d=N()(o().translator.trans(ut+"read-this-post",{count:l}));l>0&&(d+=". "+N()(o().translator.trans(ut+"read-no-further",{count:i.length}))),t.add("who-read",v().component({className:"Button Button--link",onclick:function(t){t.preventDefault(),o().modal.show(G,{readersUntilHereOnly:i,readersFurther:c})},title:d},[o().forum.attribute("who-read.showCountOfReadersWhoStopped")?i.length:l," ",at()("fas fa-check-double")," ",m(j,{readers:i})]))}}else if(a===n.length-1){var f=Q(e.clarkwinkelmannWhoReaders()).filter((function(t){return U(t.last_read_post_number())>=U(e.lastPostNumber())}));t.add("who-read",v().component({className:"Button Button--link",onclick:function(t){t.preventDefault(),o().modal.show(G,{readersEnd:f})},title:N()(o().translator.trans(ut+"read-to-end",{count:f.length}))},[f.length," ",at()("fas fa-check-double")," ",m(j,{readers:f})])),e.attribute("whoReadCanMarkUnread")&&t.add("who-read-unread",m(st,{className:"Button",discussion:e}))}}}}))})),(0,e.extend)(ct(),"userControls",(function(t,r){r.attribute("whoReadCanMarkUnread")&&t.add("who-read-unread",m(st,{discussion:r}))}))}))})(),module.exports=r})();
//# sourceMappingURL=forum.js.map